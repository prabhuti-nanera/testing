@page "/forgot-password"
@using CRC.WebPortal.BlazorWebApp.Models
@using CRC.WebPortal.BlazorWebApp.Services
@using System.ComponentModel.DataAnnotations
@inject IAuthService AuthService
@inject NavigationManager Navigation

<PageTitle>Forgot Password - CRC WebPortal</PageTitle>

<div class="container-fluid vh-100 d-flex align-items-center justify-content-center" style="background-color: #f8f9fa;">
    <div class="row w-100 justify-content-center">
        <div class="col-md-5 col-lg-4">
            <div class="card border-0 shadow-sm" style="border-radius: 12px;">
                <div class="card-body p-5">
                    <h2 class="text-center mb-4 fw-normal" style="color: #333; font-size: 28px;">Forgot Password</h2>
                    <p class="text-center mb-4" style="color: #6c757d; font-size: 14px;">
                        Enter your email address and we'll send you instructions to reset your password.
                    </p>

                    @if (!emailSent)
                    {
                        <EditForm Model="@forgotPasswordData" OnValidSubmit="@HandleForgotPassword" OnInvalidSubmit="@HandleInvalidSubmit">
                            <DataAnnotationsValidator />

                            <div class="mb-3">
                                <InputText @bind-Value="forgotPasswordData.Email" 
                                          class="form-control form-control-lg" 
                                          placeholder="Email" 
                                          type="email"
                                          style="border: 1px solid #ddd; border-radius: 8px; padding: 12px 16px; font-size: 14px;" />
                                <ValidationMessage For="@(() => forgotPasswordData.Email)" class="text-danger small mt-1" />
                            </div>

                            @if (!string.IsNullOrEmpty(errorMessage))
                            {
                                <div class="alert alert-danger" role="alert" style="border-radius: 8px; font-size: 14px;">
                                    @errorMessage
                                </div>
                            }

                            <button type="submit" 
                                    class="btn btn-primary w-100 btn-lg mb-3" 
                                    disabled="@isLoading"
                                    style="border-radius: 8px; font-weight: 500; padding: 12px;">
                                @if (isLoading)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                    <span>Sending Email...</span>
                                }
                                else
                                {
                                    <span>Send Reset Email</span>
                                }
                            </button>
                        </EditForm>
                    }
                    else
                    {
                        <div class="text-center mb-4">
                            <div class="alert alert-success" role="alert" style="border-radius: 8px;">
                                <h5 class="mb-2">Email Sent Successfully</h5>
                                <p class="mb-0">We've sent password reset instructions to <strong>@forgotPasswordData.Email</strong></p>
                                <small class="text-muted">Please check your email and follow the instructions to reset your password.</small>
                            </div>
                        </div>

                        <button class="btn btn-outline-primary w-100 btn-lg mb-3" 
                                @onclick="ResetForm"
                                style="border-radius: 8px; font-weight: 500; padding: 12px;">
                            Send Another Email
                        </button>
                    }

                    <div class="text-center mt-4">
                        <span style="color: #6c757d; font-size: 14px;">Remember your password? </span>
                        <a href="/signin" class="text-decoration-none" style="font-size: 14px; font-weight: 500;">Sign In</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private ForgotPasswordData forgotPasswordData = new();
    private bool isLoading = false;
    private string errorMessage = string.Empty;
    private bool emailSent = false;

    private void HandleInvalidSubmit()
    {
        errorMessage = string.Empty;
    }

    private async Task HandleForgotPassword()
    {
        isLoading = true;
        errorMessage = string.Empty;

        try
        {
            var result = await AuthService.ForgotPasswordAsync(forgotPasswordData);

            if (result.IsSuccess)
            {
                emailSent = true;
            }
            else
            {
                errorMessage = result.Message ?? "Failed to process forgot password request. Please try again.";
            }
        }
        catch (Exception)
        {
            errorMessage = "An error occurred while processing your request. Please try again.";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ResetForm()
    {
        emailSent = false;
        forgotPasswordData = new();
        errorMessage = string.Empty;
    }
}
