@page "/forgot-password"
@layout AuthLayout
@using CRC.Common.Models
@using Microsoft.AspNetCore.Components
@using CRC.WebPortal.BlazorWebApp.Layout
@using CRC.WebPortal.BlazorWebApp.Services
@inject IAuthService AuthService
@inject IToastService ToastService
@inject NavigationManager Navigation

<PageTitle>Forgot Password - CRC WebPortal</PageTitle>

<div class="container-fluid vh-100 d-flex align-items-center justify-content-center" style="background-color: #f8f9fa;">
    <div class="row w-100 justify-content-center">
        <div class="col-md-5 col-lg-4">
            <div class="card border-0 shadow-sm" style="border-radius: 12px;">
                <div class="card-body p-5">
                    <h2 class="text-center mb-4 fw-normal" style="color: #333; font-size: 26px;">Forgot Password</h2>
                    <p class="text-center text-muted mb-4" style="font-size: 14px;">@GetStepDescription()</p>

                    @if (currentStep == Step.EnterEmail)
                    {
                        <EditForm Model="@sendOtpRequest" OnValidSubmit="HandleSendOtp">
                        <DataAnnotationsValidator />

                            <div class="mb-3">
                                <InputText @bind-Value="sendOtpRequest.Email"
                                           class="form-control form-control-lg"
                                           placeholder="Email"
                                           type="email"
                                           style="border: 1px solid #ddd; border-radius: 8px; padding: 12px 16px; font-size: 14px;" />
                                <ValidationMessage For="@(() => sendOtpRequest.Email)" class="text-danger small mt-1" />
                            </div>


                        <button type="submit"
                                class="btn btn-primary w-100 mb-3"
                                disabled="@isLoading"
                                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 8px; padding: 12px; font-size: 16px; font-weight: 500;">
                            @if (isLoading)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                <span>Sending...</span>
                            }
                            else
                            {
                                <span>Send OTP</span>
                            }
                        </button>

                        <div class="text-center">
                            <a href="/signin" style="color: #667eea; text-decoration: none; font-weight: 500;">Back to Sign In</a>
                        </div>
                        </EditForm>
                    }
                    else if (currentStep == Step.VerifyOtp)
                    {
                        <EditForm Model="@verifyOtpRequest" OnValidSubmit="HandleVerifyOtp">
                            <DataAnnotationsValidator />

                            <div class="mb-3">
                                <label class="form-label text-muted small">Email</label>
                                <InputText @bind-Value="verifyOtpRequest.Email"
                                           class="form-control form-control-lg"
                                           readonly="true"
                                           style="border: 1px solid #ddd; border-radius: 8px; padding: 12px 16px; font-size: 14px; background-color: #f8f9fa;" />
                            </div>

                            <div class="mb-3">
                                <label class="form-label text-muted small">Enter 4-digit OTP</label>
                                <InputText @bind-Value="verifyOtpRequest.OtpCode"
                                           class="form-control form-control-lg text-center"
                                           placeholder="0000"
                                           maxlength="4"
                                           style="border: 1px solid #ddd; border-radius: 8px; padding: 12px 16px; font-size: 18px; letter-spacing: 4px;" />
                                <ValidationMessage For="@(() => verifyOtpRequest.OtpCode)" class="text-danger small mt-1" />
                            </div>

                            <div class="mb-3">
                                <label class="form-label text-muted small">New Password</label>
                                <InputText @bind-Value="verifyOtpRequest.NewPassword"
                                           class="form-control form-control-lg"
                                           placeholder="New Password"
                                           type="password"
                                           style="border: 1px solid #ddd; border-radius: 8px; padding: 12px 16px; font-size: 14px;" />
                                <ValidationMessage For="@(() => verifyOtpRequest.NewPassword)" class="text-danger small mt-1" />
                            </div>


                            <button type="submit"
                                    class="btn btn-primary w-100 mb-3"
                                    disabled="@isLoading"
                                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 8px; padding: 12px; font-size: 16px; font-weight: 500;">
                                @if (isLoading)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                    <span>Verifying...</span>
                                }
                                else
                                {
                                    <span>Reset Password</span>
                                }
                            </button>

                            <div class="text-center mb-2">
                                <button type="button" class="btn btn-link p-0" @onclick="GoBackToEmail" style="color: #667eea; text-decoration: none; font-weight: 500;">Change Email</button>
                            </div>
                        </EditForm>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private enum Step { EnterEmail, VerifyOtp }
    private Step currentStep = Step.EnterEmail;
    
    private SendOtpRequest sendOtpRequest = new();
    private VerifyOtpRequest verifyOtpRequest = new();
    private bool isLoading = false;

    private string GetStepDescription()
    {
        return currentStep switch
        {
            Step.EnterEmail => "Enter your email to receive a 4-digit OTP for password reset.",
            Step.VerifyOtp => "Enter the OTP sent to your email and set a new password.",
            _ => ""
        };
    }

    private async Task HandleSendOtp()
    {
        isLoading = true;
        try
        {
            var result = await AuthService.SendOtpAsync(sendOtpRequest);
            if (result.IsSuccess)
            {
                verifyOtpRequest.Email = sendOtpRequest.Email;
                currentStep = Step.VerifyOtp;
                await ToastService.ShowSuccessAsync("OTP sent successfully to your email.", 4000);
            }
            else
            {
                await ToastService.ShowErrorAsync(result.Message ?? "Failed to send OTP. Please try again.", 5000);
            }
        }
        catch (Exception)
        {
            await ToastService.ShowErrorAsync("An error occurred while processing your request.", 5000);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleVerifyOtp()
    {
        isLoading = true;
        try
        {
            var result = await AuthService.VerifyOtpAndResetPasswordAsync(verifyOtpRequest);
            if (result.IsSuccess)
            {
                await ToastService.ShowSuccessAsync("Password reset successfully! Redirecting to sign in...", 3000);
                await Task.Delay(1500);
                Navigation.NavigateTo("/signin");
            }
            else
            {
                await ToastService.ShowErrorAsync(result.Message ?? "Failed to verify OTP. Please try again.", 5000);
            }
        }
        catch (Exception)
        {
            await ToastService.ShowErrorAsync("An error occurred while processing your request.", 5000);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void GoBackToEmail()
    {
        currentStep = Step.EnterEmail;
        verifyOtpRequest = new();
    }
}
