@page "/forgot-password"
@using System.ComponentModel.DataAnnotations
@using CRC.WebPortal.Application.Common.Models
@inject IAuthService AuthService
@inject NavigationManager Navigation

<PageTitle>Forgot Password - CRC WebPortal</PageTitle>

<div class="auth-container">
    <div class="auth-card">
        <h2 class="auth-title">Forgot Password</h2>
        <p class="auth-subtitle">
            Enter your email address and we'll send you a verification code to reset your password.
        </p>

        @if (!otpGenerated)
        {
            <EditForm Model="@forgotPasswordRequest" OnValidSubmit="@HandleForgotPassword" OnInvalidSubmit="@HandleInvalidSubmit">
                <DataAnnotationsValidator />

                <div class="form-group">
                    <InputText @bind-Value="forgotPasswordRequest.Email" 
                               class="form-input" 
                               placeholder="Email" 
                               type="email" />
                    <ValidationMessage For="@(() => forgotPasswordRequest.Email)" class="field-validation-error" />
                </div>

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="server-error-alert">@errorMessage</div>
                }

                <button type="submit" class="btn-primary" disabled="@isLoading">
                    @if (isLoading)
                    {
                        <span>Generating Code...</span>
                    }
                    else
                    {
                        <span>Send Reset Code</span>
                    }
                </button>
            </EditForm>
        }
        else
        {
            <div class="otp-display">
                <div class="otp-label">Your Reset Code</div>
                <div class="otp-code">@generatedOtp</div>
                <div class="otp-note">Use this code to reset your password</div>
            </div>

            <div class="action-buttons">
                <button class="btn-secondary-full" @onclick="NavigateToResetPassword">
                    Continue to Reset Password
                </button>
            </div>

            <div class="resend-section">
                <span>Didn't receive the code? </span>
                <button type="button" class="auth-link" style="background: none; border: none; cursor: pointer;" @onclick="RegenerateOtp">
                    Resend Code
                </button>
            </div>
        }

        <div class="auth-footer">
            <span>Remember your password? </span>
            <a href="/signin" class="auth-link">Sign In</a>
        </div>
    </div>
</div>

@code {
    private ForgotPasswordRequest forgotPasswordRequest = new();
    private bool isLoading = false;
    private string errorMessage = string.Empty;
    private bool otpGenerated = false;
    private string generatedOtp = string.Empty;

    private void HandleInvalidSubmit()
    {
        // Clear any server errors when form is invalid
        errorMessage = string.Empty;
    }

    private async Task HandleForgotPassword()
    {
        isLoading = true;
        errorMessage = string.Empty;

        try
        {
            var result = await AuthService.ForgotPasswordAsync(forgotPasswordRequest);

            if (result.Success)
            {
                generatedOtp = GenerateOtp();
                otpGenerated = true;
            }
            else
            {
                errorMessage = result.Message;
            }
        }
        catch (Exception)
        {
            errorMessage = "An error occurred while generating reset code. Please try again.";
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GenerateOtp()
    {
        var random = new Random();
        return random.Next(100000, 999999).ToString();
    }

    private void RegenerateOtp()
    {
        generatedOtp = GenerateOtp();
    }

    private void NavigateToResetPassword()
    {
        Navigation.NavigateTo($"/reset-password?email={Uri.EscapeDataString(forgotPasswordRequest.Email)}&otp={generatedOtp}");
    }

    public class ForgotPasswordRequest
    {
        [Required(ErrorMessage = "Email is required")]
        [EmailAddress(ErrorMessage = "Invalid email format")]
        public string Email { get; set; } = string.Empty;
    }
}
